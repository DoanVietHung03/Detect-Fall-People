<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Cam Surveillance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cam-row { transition: all 0.3s ease; }
        .alert-border { border: 4px solid #EF4444; box-shadow: 0 0 15px #EF4444; }
        .safe-border { border: 2px solid #374151; }
        .snapshot-placeholder { background: repeating-linear-gradient(45deg, #1f2937, #1f2937 10px, #111827 10px, #111827 20px); }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans p-6">

    <header class="mb-8 flex justify-between items-center border-b border-gray-700 pb-4">
        <h1 class="text-3xl font-bold text-blue-500">üè¢ Central Monitoring Station</h1>
        <div class="text-sm text-gray-400">System Active ‚Ä¢ AI Running</div>
    </header>

    <div id="camera-container" class="space-y-8">
        {% for cam_id, url in cameras.items() %}
        <div id="row-{{ cam_id }}" class="bg-gray-800 rounded-xl p-4 shadow-lg cam-row safe-border">
            
            <div class="flex justify-between mb-2">
                <h2 class="text-xl font-bold uppercase tracking-wider text-gray-300">üìπ {{ cam_id }}</h2>
                <span id="status-{{ cam_id }}" class="px-3 py-1 rounded bg-green-900 text-green-300 text-xs font-bold">NORMAL</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
                
                <div class="relative bg-black rounded-lg overflow-hidden w-full">
                    <img src="/video_feed?cam_id={{ cam_id }}" 
                         class="w-full h-auto block object-contain" 
                         style="min-height: 240px;" 
                         loading="lazy">
                    <div class="absolute top-2 left-2 bg-red-600 text-white text-xs px-2 py-0.5 rounded animate-pulse">LIVE</div>
                </div>

                <div class="relative bg-gray-900 rounded-lg overflow-hidden border border-gray-700 w-full h-full min-h-[240px]">
                    <div class="absolute top-0 left-0 w-full bg-gray-800 bg-opacity-75 p-2 text-xs text-center text-gray-300 z-10">
                        üì∏ Best Evidence Snapshot
                    </div>
                    
                    <div class="w-full h-full flex items-center justify-center bg-black">
                        <img id="img-{{ cam_id }}" src="" class="w-full h-auto object-contain hidden">
                        
                        <div id="place-{{ cam_id }}" class="w-full h-full flex items-center justify-center snapshot-placeholder text-gray-500 absolute inset-0">
                            <div class="text-center">
                                <p class="text-4xl mb-2">üîç</p>
                                <p class="text-sm">No Fall Detected</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        // H√†m c·∫≠p nh·∫≠t d·ªØ li·ªáu t·ª± ƒë·ªông m·ªói gi√¢y
        setInterval(() => {
            fetch('/api/updates')
                .then(response => response.json())
                .then(states => {
                    // states = { "cam_coffee": { "fall": true, "snapshot": "..." }, ... }
                    
                    for (const [camId, data] of Object.entries(states)) {
                        const row = document.getElementById(`row-${camId}`);
                        const statusBadge = document.getElementById(`status-${camId}`);
                        const imgTag = document.getElementById(`img-${camId}`);
                        const placeTag = document.getElementById(`place-${camId}`);

                        // 1. C·∫≠p nh·∫≠t giao di·ªán c·∫£nh b√°o (Vi·ªÅn ƒë·ªè + Badge)
                        if (data.fall) {
                            row.classList.remove('safe-border');
                            row.classList.add('alert-border');
                            statusBadge.className = "px-3 py-1 rounded bg-red-600 text-white text-xs font-bold animate-pulse";
                            statusBadge.innerText = "üö® FALL DETECTED";
                        } else {
                            row.classList.remove('alert-border');
                            row.classList.add('safe-border');
                            statusBadge.className = "px-3 py-1 rounded bg-green-900 text-green-300 text-xs font-bold";
                            statusBadge.innerText = "NORMAL";
                        }

                        // 2. C·∫≠p nh·∫≠t ·∫£nh Snapshot b√™n ph·∫£i
                        if (data.snapshot) {
                            // Ch·ªâ c·∫≠p nh·∫≠t src n·∫øu ƒë∆∞·ªùng d·∫´n kh√°c v·ªõi hi·ªán t·∫°i ƒë·ªÉ tr√°nh nh√°y h√¨nh
                            // Th√™m timestamp ·ªü ƒëu√¥i (?t=...) ƒë·ªÉ √©p tr√¨nh duy·ªát load ·∫£nh m·ªõi n·∫øu server ghi ƒë√® file c≈©
                            if (!imgTag.src.includes(data.snapshot)) {
                                imgTag.src = data.snapshot;
                                imgTag.classList.remove('hidden');
                                placeTag.classList.add('hidden');
                            }
                        }
                    }
                })
                .catch(err => console.error("Update error:", err));
        }, 1000); // 1 gi√¢y check 1 l·∫ßn
    </script>
</body>
</html>